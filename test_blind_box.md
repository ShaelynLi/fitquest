# 盲盒系统测试用例

## 测试准备
1. 设置用户的 petRewardGoal = 6 (6km/盲盒)
2. 清空现有的workout数据
3. 重启应用

## 测试用例

### 用例1: 基础测试 - 刚好达到目标
**输入**: 跑步 6km
**预期结果**:
- ✅ 获得盲盒: 1个
- ✅ 进度条: 0m / 6000m (0%)
- ✅ 剩余距离: 6000m

**数据库操作**:
```javascript
// 在 users/{uid}/workouts/ 添加:
{
  "distance": { "meters": 6000, "kilometers": 6 },
  "status": "completed",
  "created_at": "2025-10-13T10:00:00Z"
}
```

---

### 用例2: 有剩余距离
**输入**: 跑步 8km
**预期结果**:
- ✅ 获得盲盒: 1个
- ✅ 进度条: 2000m / 6000m (33%)
- ✅ 剩余距离: 4000m

**数据库操作**:
```javascript
{
  "distance": { "meters": 8000, "kilometers": 8 },
  "status": "completed",
  "created_at": "2025-10-13T10:00:00Z"
}
```

---

### 用例3: 多个盲盒
**输入**: 跑步 15km
**预期结果**:
- ✅ 获得盲盒: 2个
- ✅ 进度条: 3000m / 6000m (50%)
- ✅ 剩余距离: 3000m

**数据库操作**:
```javascript
{
  "distance": { "meters": 15000, "kilometers": 15 },
  "status": "completed",
  "created_at": "2025-10-13T10:00:00Z"
}
```

---

### 用例4: 累计跑步（多次workout）
**输入**: 
- 第一次跑步: 4km
- 第二次跑步: 3km
- 总计: 7km

**预期结果**:
- ✅ 获得盲盒: 1个
- ✅ 进度条: 1000m / 6000m (16.67%)
- ✅ 剩余距离: 5000m

**数据库操作**:
```javascript
// Workout 1
{
  "distance": { "meters": 4000, "kilometers": 4 },
  "status": "completed",
  "created_at": "2025-10-13T08:00:00Z"
}

// Workout 2
{
  "distance": { "meters": 3000, "kilometers": 3 },
  "status": "completed",
  "created_at": "2025-10-13T10:00:00Z"
}
```

---

### 用例5: 打开盲盒后继续累计
**步骤**:
1. 跑步 8km → 获得1个盲盒，剩余2km
2. 打开盲盒 → 剩余盲盒: 0个，进度仍然是2km
3. 再跑步 5km → 进度变为7km
4. 结果 → 获得1个新盲盒，剩余1km

**预期结果**:
- ✅ 总跑步: 13km
- ✅ 总获得盲盒: 2个
- ✅ 已打开: 1个
- ✅ 未打开: 1个
- ✅ 进度条: 1000m / 6000m (16.67%)

---

### 用例6: 更改目标距离
**步骤**:
1. 设置 petRewardGoal = 6
2. 跑步 10km → 获得1个盲盒，剩余4km
3. 修改 petRewardGoal = 3
4. 重启应用

**预期结果**:
- ✅ 总距离: 10km
- ✅ 新的计算: 10000 ÷ 3000 = 3个盲盒
- ✅ 获得盲盒: 3个（新增2个）
- ✅ 进度条: 1000m / 3000m (33%)

---

## 验证清单

每次测试后检查：

- [ ] 控制台日志显示正确的盲盒数量
- [ ] 主页盲盒图标显示正确数字
- [ ] 进度条百分比正确
- [ ] 进度条显示的米数正确
- [ ] "remaining distance" 显示正确
- [ ] 可以成功打开盲盒
- [ ] 打开盲盒后数量减1
- [ ] 进度条在打开盲盒后保持不变

---

## 常见问题排查

### 问题1: 盲盒数量不正确
**检查**:
- Firebase数据库中的workout距离是否正确
- petRewardGoal是否设置正确
- 查看控制台日志中的计算过程

### 问题2: 进度条不更新
**检查**:
- 是否重启了应用
- 是否从后台切换到前台（触发刷新）
- 网络连接是否正常

### 问题3: 数据不同步
**解决**:
```bash
# 清除应用缓存
npx expo start --clear

# 或在代码中清除AsyncStorage
await AsyncStorage.clear();
```

